# üìò Project Best Practices

## 1. Project Purpose
This is an asynchronous Telegram bot for psychological support service called "–ò–∑–ª–∏–≤–∞–Ω–∏–µ –¥—É—à–∏" (Soul Outpouring). Users send voice messages to express their feelings and receive empathetic voice responses generated by GPT-4. The bot provides a safe space for emotional expression with time-limited sessions and administrative oversight.

## 2. Project Structure
- **bot.py** - Main bot module with FSM (Finite State Machine) conversation handler
- **stt.py** - Speech-to-text functionality using OpenAI Whisper
- **tts.py** - Text-to-speech functionality using OpenAI TTS (onyx model)
- **gpt.py** - GPT-4 API integration for generating empathetic responses
- **admin.py** - Administrative commands (/prompt, /setprompt, /resetprompt, /stats, /cleanup)
- **utils.py** - Utilities for temp files, session timers, and admin notifications
- **config.py** - Configuration management and environment variable loading
- **data/** - Contains system prompt file (prompt.txt)
- **temp/** - Temporary audio files (auto-created, auto-cleaned)

## 3. Test Strategy
- **Framework**: No formal testing framework currently implemented
- **Testing Philosophy**: Manual testing and production monitoring through logging
- **Recommendations**: 
  - Add pytest for unit testing core functions
  - Mock OpenAI API calls for testing
  - Test conversation flow states and error handling
  - Add integration tests for audio processing pipeline

## 4. Code Style
- **Language**: Python 3.10+ with async/await patterns throughout
- **Naming Conventions**:
  - Functions: snake_case (e.g., `handle_voice_message`, `send_to_admins`)
  - Classes: PascalCase (e.g., `PsychologyBot`, `SessionTimer`)
  - Constants: UPPER_SNAKE_CASE (e.g., `MAX_MESSAGES_PER_SESSION`)
  - Files: snake_case.py
- **Async Usage**: All bot handlers and API calls are async
- **Type Hints**: Used in function signatures, especially for return types
- **Docstrings**: Triple-quoted docstrings for modules and functions
- **Error Handling**: Comprehensive try-catch blocks with specific error messages for users
- **Logging**: Structured logging with different levels (INFO, ERROR, DEBUG)

## 5. Common Patterns
- **FSM States**: Uses ConversationHandler with states (AWAIT_NAME, MAIN_MENU, RECORDING)
- **Temporary File Management**: Create with `create_temp_file()`, cleanup with `cleanup_temp_file()`
- **Admin Notifications**: Use `send_to_admins()` for debugging and monitoring
- **Session Management**: `SessionTimer` class for tracking session duration
- **Configuration**: Environment variables loaded via python-dotenv
- **Error Propagation**: Catch API errors and convert to user-friendly messages
- **Resource Cleanup**: Always cleanup temp files in finally blocks

## 6. Do's and Don'ts

### ‚úÖ Do's
- Always use async/await for bot handlers and API calls
- Cleanup temporary files in finally blocks
- Log important events with appropriate log levels
- Validate user input before processing
- Use type hints for function parameters and returns
- Handle API rate limits and quota errors gracefully
- Check admin permissions before executing admin commands
- Use environment variables for sensitive configuration

### ‚ùå Don'ts
- Don't store sensitive data in code (use .env file)
- Don't forget to cleanup temporary audio files
- Don't expose internal errors to users (convert to friendly messages)
- Don't hardcode file paths (use Path objects from pathlib)
- Don't ignore session time limits and message count limits
- Don't send voice messages to admins unless DEBUG_SEND_VOICE=true
- Don't use blocking I/O operations in async functions

## 7. Tools & Dependencies
- **python-telegram-bot v20.x** - Async Telegram bot framework
- **OpenAI API** - GPT-4 for responses, Whisper for STT, TTS for voice synthesis
- **pydub + ffmpeg** - Audio file processing and format conversion
- **python-dotenv** - Environment variable management
- **pathlib** - Modern path handling
- **asyncio** - Asynchronous programming support

### Setup Requirements
1. Install ffmpeg system dependency for audio processing
2. Configure .env file with TELEGRAM_TOKEN, OPENAI_API_KEY, and ADMIN_IDs
3. Ensure temp/ and data/ directories exist (auto-created)

## 8. Other Notes
- **Session Limits**: 30-minute sessions, max 10 messages per session, 7-minute voice message limit
- **Audio Processing**: Voice messages are converted to text, processed by GPT-4, then converted back to speech
- **Admin Features**: Real-time prompt modification, statistics, cleanup commands
- **Logging**: All sessions logged to session.log with duration and message count
- **Debug Mode**: DEBUG_SEND_VOICE controls whether voice messages are forwarded to admins
- **Error Recovery**: Bot continues operation even if individual components fail
- **Russian Language**: All user-facing messages and prompts are in Russian
- **State Management**: Uses telegram-bot's ConversationHandler for managing user conversation states
- **File Safety**: Temporary files have unique timestamps to avoid conflicts
- **API Limits**: Handles OpenAI rate limits and quota exceeded errors gracefully